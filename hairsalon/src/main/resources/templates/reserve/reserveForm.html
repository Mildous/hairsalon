<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<!-- CSS-->
<th:block layout:fragment="css">
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css" />
	<style>
        .fieldError {
            color: #bd2130;
        }
	</style>
</th:block>

<!-- JS -->
<th:block layout:fragment="script">
	<script th:inline="javascript">
        $(document).ready(function(){
            $.datepicker.setDefaults($.datepicker.regional['ko']);
            $( "#rsvDate" ).datepicker({
                changeMonth: true,
                changeYear: true,
                nextText: '다음 달',
                prevText: '이전 달',
                dayNames: ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'],
                dayNamesMin: ['일', '월', '화', '수', '목', '금', '토'],
                monthNamesShort: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
                monthNames: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
                dateFormat: 'yy-mm-dd',
                minDate: 0 // ( 0 : 오늘 이전 날짜 선택 불가)
            });
            var errorMessage = [[${errorMessage}]];
            if(errorMessage != null){
                alert(errorMessage);
            }
            $('#typeId').on('change', function () {
                $('#longTime').val(($("#typeId option:selected").data('minute')));
            });
        });

        function selectTime(start) {
            let date = new Date($('#rsvDate').val())
            let long = Number($('#longTime').val());
            let [hour, minute, second] = start.split(':');
            date.setHours(hour, minute, second, 0);
            $('#rsvStartTime').val(start);
            date.setMinutes(date.getMinutes() + long);
            hour = date.getHours();
            minute = date.getMinutes().toString().padStart(2, '0');
            second = date.getSeconds().toString().padStart(2, '0');
            const time = `${hour}:${minute}:${second}`;
            $('#rsvEndTime').val(time);
        }
        function changeDate(rsvDate) {
            // '예약시간' 라벨 보여주기
	        $('#time_label').show();
            // 날짜 변경 시 기존 버튼 삭제
	        var timeList = document.getElementById("timeList");
	        while (timeList.firstChild) {
		        timeList.removeChild(timeList.firstChild);
            }
            var token = $("meta[name='_csrf']").attr("content");
            var header =  $("meta[name='_csrf_header']").attr("content");
            var paramData = {
                rsvDate: rsvDate
            };
            var param = JSON.stringify(paramData);

            $.ajax({
                url: "/reserve/getTime",
                type: "POST",
                contentType: "application/json",
	            data: param,
	            beforeSend: function (xhr){
                    /* 데이터 전송 전 헤더에 csrf 값 설정 */
		            xhr.setRequestHeader(header, token);
	            },
	            dataType: "json",
	            cache: false,
	            success: function (data) {
                    console.log(data);
					// ajax로 얻은 시간 범위 데이터
                    var timeRanges = data;

					// 모든 시간대에 해당하는 버튼 생성
                    for (var i = 11; i < 21; i++) {
                        for (var j = 0; j < 60; j += 30) {
                            var hour = i < 10 ? "0" + i : i;
                            var minute = j === 0 ? "00" : "30";
                            var time = hour + ":" + minute;

                            // 시간대가 범위에 속하지 않으면 버튼 생성
                            if (!isTimeInRange(time, timeRanges)) {
                                createButton(time);
                            }
                        }
                    }

					// 시간대가 범위에 속하는지 확인하는 함수
                    function isTimeInRange(time, ranges) {
                        for (var i = 0; i < ranges.length; i++) {
                            var startEnd = ranges[i].split("-");
                            var startTime = startEnd[0];
                            var endTime = startEnd[1];

                            if (time >= startTime && time <= endTime) {
                                return true;
                            }
                        }
                        return false;
                    }

					// 버튼 생성 함수
                    function createButton(time) {
                        var button = document.createElement("button");
                        button.innerHTML = time;
                        button.value = time + ":00"; // 버튼 값 추가
                        button.type = "button"; // type 속성 추가
                        button.classList.add("btn", "btn-success", "mx-1", "my-1"); // 클래스 추가
                        // 버튼 클릭 이벤트 등록
                        button.addEventListener("click", function() {
                            // 클릭한 버튼의 시간대에 대한 처리
	                        selectTime(this.value);
                        });
                        // 버튼을 표시할 요소에 추가
                        document.getElementById("timeList").appendChild(button);
                    }

					// 범위에 해당하는 시간대를 가진 버튼 숨기기
                    for (var i = 0; i < timeRanges.length; i++) {
                        var startEnd = timeRanges[i].split("-");
                        var startTime = startEnd[0];
                        var endTime = startEnd[1];

                        for (var j = 11; j < 21; j++) {
                            for (var k = 0; k < 60; k += 30) {
                                var hour = j < 10 ? "0" + j : j;
                                var minute = k === 0 ? "00" : "30";
                                var time = hour + ":" + minute;

                                // 시간대가 범위에 속하면 버튼 숨기기
                                if (time >= startTime && time <= endTime) {
                                    //var button = document.querySelector(`button[value="${time}:00"]`);
                                    var button = document.getElementById(time.replace(":", ""));
                                    if (button) {
                                        button.style.display = "none";
                                    }
                                }
                            }
                        }
                    }

                    //<button type="button" class="btn btn-outline-success" onclick="selectTime(this.value)" value="11:00:00">11:00</button>
	            },
	            error: function () {
		            console.log("error");
	            }
            });
        }
	</script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script src="http://code.jquery.com/ui/1.8.18/jquery-ui.min.js"></script>
</th:block>

<div layout:fragment="content">
	<h4 class="mb-3 font-weight-bold">고객 정보</h4>
		<table class="table table-striped table-dark">
			<thead>
			<tr>
				<th scope="col" class="col-md-4">이름</th>
				<th scope="col" class="col-md-4">연락처</th>
				<th scope="col" class="col-md-2">성별</th>
			</tr>
			</thead>
			<tbody>
			<tr>
				<td th:text="${member.name}"></td>
				<td th:text="${#strings.substring(member.phone, 0, 3) + '-' +
                                #strings.substring(member.phone, 3, 7) + '-' +
                                #strings.substring(member.phone, 7)}"></td>
				<td th:text="${member.gender == T(com.ubn.hairsalon.member.constant.Gender).MALE} ? '남성' : '여성'"></td>
			</tr>
			</tbody>
		</table><br>
	<h4 class="my-3 font-weight-bold">예약 정보</h4>
		<form role="form" method="post" th:object="${reserveFormDto}">
			<input type="hidden" th:field="*{memberId}" th:value="${member.id}">
			<input type="hidden" th:field="*{id}">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label th:for="rsvDate">날짜</label>
					<input type="text" th:field="*{rsvDate}" class="datepicker form-control" placeholder="Select Date" th:onchange="|changeDate(this.value)|">
					<p th:if="${#fields.hasErrors('rsvDate')}" th:errors="*{rsvDate}" class="fieldError">Incorrect data</p>
				</div>
				<div class="form-group col-md-6">
					<label th:for="typeId">타입</label>
					<select th:field="*{typeId}" class="custom-select" id="typeId" >
						<option th:each="type : ${types}" th:value="${type.id}" th:text="${type.typeName + ' - (' + type.takeMinutes + ')'}" th:data-minute="${type.takeMinutes}"></option>
					</select>
					<p th:if="${#fields.hasErrors('typeId')}" th:errors="*{typeId}" class="fieldError">Incorrect data</p>
				</div>
			</div>

			<div class="form-row">
				<div class="form-group col-md-6" id="time">
					<input type="hidden" th:field="*{rsvStartTime}">
				</div>
				<div class="form-group col-md-6">
					<input type="hidden" id="longTime" value="30">
					<input type="hidden" th:field="*{rsvEndTime}">
				</div>
			</div>

			<div th:unless="${#strings.isEmpty(reserveFormDto.id)}" class="form-group mb-3">
				<label th:for="reservedTime">기존 예약 시간</label><br>
				<input type="text" class="form-control" th:value="${reserveFormDto.getRsvStartTime()}" disabled>
			</div>

			<div class="form-group">
				<label th:for="timeList" style="display: none;" id="time_label">예약시간</label>
				<div id="timeList">
				</div>
				<p th:if="${#fields.hasErrors('rsvStartTime')}" th:errors="*{rsvStartTime}" class="fieldError">Incorrect data</p>
			</div>

			<div th:if="${#strings.isEmpty(reserveFormDto.id)}" style="text-align: center">
				<button th:formaction="@{/reserve/new}" type="submit" class="btn btn-primary mt-3">Submit</button>
			</div>
			<div th:unless="${#strings.isEmpty(reserveFormDto.id)}" style="text-align: center">
				<button th:formaction="@{'/members/reserved/edit/' + ${reserveFormDto.id} }" type="submit" class="btn btn-primary mx-2">Update</button>
				<button class="btn btn-danger mx-2" onclick="javascript:history.back(); return false;">Cancel</button>
			</div>

			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
		</form>
</div>
</html>